基于树的算法在机器学习生态系统中是众所周知的，它们主要以表格类的监督任务而闻名。在学习过程中，\ **树的分裂标准只关注相关特征和有用值的范围，梯度提升擅长学习交互**\ ，所以给定一组表格特征和要预测的目标，无需太多配置和特定的预处理就可以得到令人满意的结果。

但是\ **基于树和梯度提升模型在时间序列预测领域的表现并不好，很多人更倾向于深度学习的方法**\ 。这并不奇怪，因为\ **基于树的模型的弱点在于：在技术上无法推断出比训练数据中更高/更低的特征值**\ 。\ **他们几乎不可能预测所见区间之外的值。**

例如在，销量预测中，对于销量的\ **趋势性非常明显的城市**\ ，预测的结果非常差。

**核心的原因是tree没有办法做“外推”，真是tree系列模型本身的致命缺陷。**
|image1|

.. _1-树模型为什么没有外推能力:

1 树模型为什么没有外推能力？
============================

像这样趋势性非常强的数据，GBDT是没有办法拟合的，以单Tree为例，Tree的叶子节点的值是\ **已知标签的值的平均**\ ，而对于GBDT的集成模型而言，\ **某个样本是其落在的所有子树的叶子上的值的加权平均（权重是学习率）**\ 。

这导致的问题就是我们的预测结果一定是介于\ `序列数据 <https://www.zhihu.com/search?q=%E5%BA%8F%E5%88%97%E6%95%B0%E6%8D%AE&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A311883742%7D>`__\ 的最大和最小值之间的，例如[1,2,3,4,5,6,....1000]，使用Tree或者\ `集成决策树 <https://www.zhihu.com/search?q=%E9%9B%86%E6%88%90%E5%86%B3%E7%AD%96%E6%A0%91&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22%3A%22article%22%2C%22sourceId%22%3A311883742%7D>`__\ 最终预测的结果在绝大部分情况下不会大于1000，这就意味着一旦我们未来的日子，销量突破新高，例如到达了2000或者3000,....等等，Tree是预测不出来的，这也是\ **为什么我使用原始标签进行预测总是发现模型预测的结果偏小**\ ，而且小了很多。

因为我使用的是所有的历史数据，我们知道电商的销量从早期的2010年到现在，已经不是一个数量级，支付宝双十一的销售额也是年年创下新高。

**这样的效应对于大型城市来说是非常明显的，北上广的电商销量基本上是往上走的就像上面这幅图一样，不过一些n线小城市的销量整体稳定，这也是为什么做bad
case的时候发现小型城市的预测比较准，大型城市的预测差的一批。**

**但是对于线性回归模型或者是NN模型来说，则没有外推能力差的问题。**

.. _2-如何解决树模型的外推能力:

2 如何解决树模型的外推能力
==========================

处理的方式就是

树模型不会外推，因此，如果要将其用于外推预测，则需要\ **创建隐含外推的特征**\ 。例如：

-  可以将简单的\ **线性模型**\ 与\ **时间变量**\ 拟合，然后\ **将预测用作特征。**

-  使用\ **残差**\ 作为\ **目标**\ 。

-  使用\ **变化率**\ 作为\ **特征**\ ，通过适当的特征工程，对树模型仍然会很有帮助，通常特征工程至关重要。

-  对标签进行变换，注意，对数变换\ **可以在一定程度消除未来和当前的差异**\ ，但是属于\ **治标不治本**\ 的方法。

-  **使用差分变换或者是增长率变换才可能消除这种差异。**

..

   但是实际上，差分变换不一定有效（我做的结果就是这样），因为差分变换之后，我们还要把差分预测的结果转化为最终的真实销量，这个时候你会发现，特么转化之后的预测销量出现负数。。。。fuck。。。这个其实很头疼，差分处理之后，模型的mse
   mae之类的确实下降了，但是销量预测为负数，业务上根本过不去，就很恶心。

下一步打算上NN模型的框架（线性回归的baseline误差太大，没法用，不过可以考虑以某种方式和GBDT集成弥补其外推能力差的问题），NN毕竟是老牌万能拟合器，趋势性的信号有希望能够拟合进模型中。

.. |image1| image:: https://cdn.nlark.com/yuque/0/2021/png/200056/1639462844499-f4307e37-791a-4bc6-b36d-bd951606c5a8.png#clientId=u69e9b6ac-2497-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=261&id=u89ed37d1&margin=[object Object]&name=image.png&originHeight=522&originWidth=736&originalType=binary&ratio=1&rotation=0&showTitle=false&size=168090&status=done&style=none&taskId=u16f02c88-ffbb-42c3-97ab-3768da8b5ab&title=&width=368
