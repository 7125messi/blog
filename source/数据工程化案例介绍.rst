==================
æ•°æ®å·¥ç¨‹åŒ–æ¡ˆä¾‹ä»‹ç»
==================

:Date:   2020-08-03T21:31:10+08:00

[åŸåˆ›]

æ•°æ®å·¥ç¨‹åŒ–æ¡ˆä¾‹ä»‹ç»
==================

å¥½ä¹…æ²¡å†™åšå®¢äº†ğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒğŸ˜ƒï¼Œæœ€è¿‘åšå®Œäº†ä¸€ä¸ªåæ•°æ®å·¥ç¨‹çš„é¡¹ç›®ï¼Œç³»ç»Ÿçš„ä½¿ç”¨äº†å¤§æ•°æ®ç›¸å…³ç»„ä»¶ï¼Œå­¦ä¹ äº†Hadoopç”Ÿæ€åœˆæŠ€æœ¯ä»¥åŠæ•°æ®ä»“åº“ç›¸å…³çŸ¥è¯†ã€‚ä¸‹é¢å°†ä¸€äº›ä½“ä¼šå†™ä¸‹ã€‚ã€‚ã€‚

.. _1-é¡¹ç›®èƒŒæ™¯å’Œä¸šåŠ¡ç‰¹ç‚¹:

1 é¡¹ç›®èƒŒæ™¯å’Œä¸šåŠ¡ç‰¹ç‚¹
====================

XXXåŒ»è¯ä¸šåŠ¡åœºæ™¯ï¼šä»¥ç»ˆç«¯æ¶ˆè´¹è€…ä¸ºä¸­å¿ƒçš„æœåŠ¡ï¼Œä»¥é—¨åº—ã€è¿é”åŠ ç›Ÿã€æ‰¹å‘æ¨¡å¼è§¦è¾¾ï¼Œå½“å‰æ ¸å¿ƒç«äº‰åŠ›æ˜¯å“ç‰ŒåŠ ç›Ÿå’Œä¾›åº”é“¾é‡‡è´­èƒ½åŠ›ã€‚éšç€åŠ ç›Ÿä¸šåŠ¡å¿«é€Ÿæˆé•¿ï¼Œè‡´åŠ›äºæˆä¸ºä¸­å›½æœ€å¤§çš„é›¶å”®è¯æˆ¿åŠ ç›Ÿå•†ï¼Œéœ€è¦é…å¥—æˆé•¿çš„ä¾›åº”é“¾ç‰©æµèƒ½åŠ›å’Œä¿¡æ¯åŒ–å»ºè®¾ã€‚â€œé«˜åº“å­˜ã€é«˜é€€è´§ã€é«˜æ•ˆæœŸâ€
ç­‰ç¯èŠ‚ç²¾ç»†åŒ–è¿è¥çš„è–„å¼±æ˜¯ä¸»è¦åŸå› ï¼Œå…·ä½“è¡¨ç°åœ¨ä»¥ä¸‹å‡ ç‚¹ï¼š

-  (1) é—¨åº—è¡¥è´§é ç»éªŒï¼Œé€ æˆäº†â€œé«˜é€€è´§â€;

-  (2) åŠ ç›Ÿåº—å’Œæ‰¹å‘å•†ç­‰ç‰©æµèƒ½åŠ›å°šæœªè§¦è¾¾ã€ç‰©æµä¿¡æ¯å°šæœªçº¿ä¸ŠåŒ–;

-  (3) ä¸ä¾›åº”å•†ä¿¡æ¯æ²Ÿé€šå‡ä¸ºçº¿ä¸‹,è¡¥è´§é¢‘æ¬¡è¾ƒä¸ºä¼ ç»Ÿ;

-  (4) é‡‡è´­è®¡åˆ’ä¾èµ–é‡‡è´­å‘˜ä¸ªäººç»éªŒé‡‡ç”¨å…¬å¼è®¡ç®—ï¼Œæœªè€ƒè™‘å¤æ‚å› ç´ ;

é¡¹ç›®ç›®æ ‡æ˜¯æ„å»ºä»¥æ™ºèƒ½è¡¥è´§ä¸ºæ™ºæ…§å¤§è„‘çš„éœ€æ±‚é©±åŠ¨çš„å…¨å±€ã€åŠ¨æ€ã€å¹³è¡¡çš„æ•°å­—åŒ–ä¾›åº”é“¾è¿è¥ä½“ç³»ï¼Œæä¾›å®‰å…¨ã€é«˜æ•ˆã€ç²¾å‡†çš„ä¾›åº”é“¾èƒ½åŠ›ã€‚ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹éƒ¨åˆ†ï¼š

-  (1) æ•°æ®æ¸…æ´—

-  (2) ç‰¹ç§å·¥ç¨‹

-  (3) æ¨¡å‹è®­ç»ƒ

-  (4) æ¨¡å‹èåˆ

-  (5) æ•°æ®å·¥ç¨‹åŒ–

å…¶ä¸­å‰4ä¸ªéƒ¨åˆ†æ˜¯æœºå™¨å­¦ä¹ çš„å¸¸è§æ–¹æ³•å’Œæ­¥éª¤,è€ƒè™‘åˆ°çº¿ä¸Šç”Ÿäº§ç¯å¢ƒè¦èƒ½æ­£å¸¸æ‰§è¡Œ,ç¬¬5éƒ¨åˆ†æ•°æ®å·¥ç¨‹åŒ–éƒ¨åˆ†å¯åŠ¨éå¸¸é‡è¦çš„åœ°ä½,ä¸‹é¢å¯¹è¿™ä¸ªéƒ¨åˆ†è¿›è¡Œè¯¦ç»†çš„å™è¿°ã€‚

.. _2-æ•°æ®å·¥ç¨‹åŒ–æµç¨‹æ¶æ„:

2 æ•°æ®å·¥ç¨‹åŒ–æµç¨‹æ¶æ„
====================

.. figure:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596449340543-5da7a315-e3b9-4512-9a99-a5fcf0979769.png#align=left&display=inline&height=901&margin=[object Object]&name=é¡¹ç›®æ¶æ„è®¾è®¡.png&originHeight=901&originWidth=1605&size=46983&status=done&style=none&width=1605
   :alt: 

è¿™é‡Œæˆ‘ä»¬çš„æ•°æ®æºä¸»è¦Oracleä¸šåŠ¡æ•°æ®ä»¥åŠä¸€äº›å®¢æˆ·æä¾›çš„äººå·¥æ•°æ®,åˆ©ç”¨sqoopæ¯æ—¥å‡Œæ™¨00:40å®šæ—¶åŒæ­¥æ•°æ®è‡³Hadoopé›†ç¾¤srcå±‚ã€‚æŒ‰ç…§ç»å…¸çš„Kappaæ•°æ®ä»“åº“åˆ†å±‚æ¶æ„åˆ†ä¸º:src->ods->dw1->dw2->app.

ä¸ä¼ ç»Ÿçš„æ•°ä»“å»ºæ¨¡ä¸åŒçš„æ˜¯æˆ‘ä»¬ä¸»è¦çš„ç›®çš„æ˜¯åˆ©ç”¨æœºå™¨å­¦ä¹ æ–¹æ³•è¿›è¡Œé¢„æµ‹è¡¥è´§,æ•°æ®ä»“åº“ods/dw1éƒ½æ˜¯æ•°æ®æ¸…æ´—å’Œå¤æ‚ä¸šåŠ¡é€»è¾‘å¤„ç†,dw2æ˜¯ç‰¹å¾å·¥ç¨‹å¤„ç†ç”Ÿæˆå®½è¡¨ç”¨äºè®­ç»ƒæ¨¡å‹ã€‚åœ¨æ•°æ®æ¸…æ´—çš„è¿‡ç¨‹ä¸­ä¼šæœ‰ä¸€äº›æŒ‡æ ‡ç”¨äºKPIå±•ç¤ºä»¥åŠappæ¨¡å‹é¢„æµ‹è¡¥è´§ç»“æœæˆ‘ä»¬ä¼šåŒæ­¥è‡³MySQL,è¿™äº›éƒ½æ˜¯ä½œä¸ºæ•°æ®åº”ç”¨æœåŠ¡ã€‚

æ•´ä¸ªæ•°æ®å·¥ç¨‹åŸºäºHadoopç”Ÿæ€åœˆæŠ€æœ¯ä¸ºè½½ä½“,æ•°æ®å­˜å‚¨ä¸»è¦æ˜¯HDFS,æ•°æ®è®¡ç®—ä¸»è¦æ˜¯Hive/Spark,å…ƒæ•°æ®ç®¡ç†æ˜¯Apache
Atlas,æ•°æ®è´¨é‡åˆ†æç”¨çš„æ˜¯Apache
Griffin,æ•°æ®ä»»åŠ¡æµè°ƒåº¦ç³»ç»Ÿç”¨çš„æ˜¯Azkaban,æ•°æ®OLAPæ•°æ®åº“æ˜¯Presto,æ•°æ®åˆ†æå¯è§†åŒ–Dashboardç”¨çš„æ˜¯Supersetã€‚è¿™äº›å¤§æ•°æ®ç»„ä»¶é‡‡ç”¨Cloudera
Manager(CM)è¿›è¡Œç»Ÿä¸€å®‰è£…é…ç½®,ä¸ºäº†ä¿è¯æœåŠ¡çš„é«˜å¯ç”¨(HA)é‡‡ç”¨Zookeeperè¿›è¡Œèµ„æºè°ƒåº¦å’Œç®¡ç†ã€‚

.. _3-æ•°æ®å·¥ç¨‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²:

3 æ•°æ®å·¥ç¨‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
======================

.. figure:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596449420934-49e3759a-9ba2-420a-87ab-7a3d1085ff80.png#align=left&display=inline&height=422&margin=[object Object]&name=ç”Ÿäº§ç¯å¢ƒå…¨æµç¨‹éƒ¨ç½².png&originHeight=422&originWidth=1809&size=34660&status=done&style=none&width=1809
   :alt: 

.. _31-å¯é…ç½®é¡¹:

3.1 å¯é…ç½®é¡¹
------------

é…ç½®é¡¹å¯¹äºæ•°æ®å·¥ç¨‹çš„é‡è¦æ€§ä¸è¨€è€Œå–»,å¯çµæ´»è°ƒæ•´éƒ¨ç½²ä»£ç ,æ–¹ä¾¿æ§åˆ¶ç®¡ç†

.. code:: 

   â”œâ”€conf
   â”‚  â”‚  config.ini         æ‰€æœ‰å¯é…ç½®å‚æ•°
   â”‚  â”‚  env_name.conf      ç”Ÿäº§ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒçš„æ ‡è¯†ç¬¦
   â”‚  â”‚  ini.sh             è¯»å†™é…ç½®æ–‡ä»¶çš„å‡½æ•°

ä¾‹å¦‚:

.. code:: yaml

   [replenish_parameters]
   start_date=2020-07-18
   end_date=2020-08-31 
   rolling_day=7
   rolling_num=50

   [env_parameters]
   data_base_dir=/data
   base_dir_jar=/root

è¿™æ ·æˆ‘ä»¬å¯¹äºæ¯å¼ è¡¨çš„è®¡ç®—æ·»åŠ ç»Ÿä¸€çš„é…ç½®é¡¹

.. code:: shell

   exe_hive=`bash /root/ini.sh /root/config.ini env_parameters exe_hive`
   exe_spark_sql=`bash /root/ini.sh /root/config.ini env_parameters exe_spark_sql`
   database_name=`bash /root/ini.sh /root/config.ini env_parameters database_name`
   master_org_id=`bash /root/ini.sh /root/config.ini env_parameters master_org_id`

.. _32-ä»»åŠ¡æµè°ƒåº¦:

3.2 ä»»åŠ¡æµè°ƒåº¦
--------------

ç¼–å†™å…¨å±€ä»»åŠ¡çš„é…ç½®æ–‡ä»¶

.. code:: yaml

   # default project work directory
   JOB_BASE_DIR=/root/code

   success.emails=user1@163.com,user2@163.com
   failure.emails=user1@163.com,user2@163.com

ç¼–å†™jobä»»åŠ¡

.. code:: yaml

   type=command
   dependencies=ods_6_kpi_wh_supplyer_bol_retailer_bol
   retries=3
   retry.backoff=10000

   #$(date +%F)
   #job_param_compute_date=${ui_param_compute_date}

   command=bash         ${JOB_BASE_DIR}/df_model_output/01_shop_op_bol.sh

ä»»åŠ¡æµç¨‹å›¾\ |image1|

.. _33-å…ƒæ•°æ®ç®¡ç†:

3.3 å…ƒæ•°æ®ç®¡ç†
--------------

å…ƒæ•°æ®ç®¡ç†å’Œæ²»ç†åŠŸèƒ½ï¼Œç”¨ä»¥æ„å»ºå…¶æ•°æ®èµ„äº§ç›®å½•ï¼Œå¯¹è¿™äº›èµ„äº§è¿›è¡Œåˆ†ç±»å’Œç®¡ç†ï¼Œå¹¶ä¸ºæ•°æ®åˆ†æå¸ˆå’Œæ•°æ®æ²»ç†å›¢é˜Ÿï¼Œæä¾›å›´ç»•è¿™äº›æ•°æ®èµ„äº§çš„åä½œåŠŸèƒ½ã€‚

-  è¡¨ä¸è¡¨ä¹‹é—´çš„è¡€ç¼˜ä¾èµ–

-  å­—æ®µä¸å­—æ®µä¹‹é—´çš„è¡€ç¼˜ä¾èµ– |image2|

.. _34-æ•°æ®è´¨é‡ç›‘æ§:

3.4 æ•°æ®è´¨é‡ç›‘æ§
----------------

æ£€æŸ¥å…³é”®è¡¨çš„ç”Ÿæˆè®°å½•æ•°å’Œå­—æ®µé˜ˆå€¼
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. code:: shell

   function check_wcl(){
           echo "å¼€å§‹æ£€æŸ¥$1"
           answer=`cat $1|wc -l`
           if [ $answer != $2 ]; then
                   echo "ã€å¼‚å¸¸ã€‘ERROR_LINE_COUNT: $1 should be $2 lines, now $answer lines"
           fi
           echo "ç»“æŸæ£€æŸ¥$1"
           echo
   }

   function check_range(){
           echo "å¼€å§‹æ£€æŸ¥$1"
           cat $1|awk -F' ' -v col=$2 -v lower=$3 -v upper=$4 '{ if (NR>1 && $(col)>upper) print "ã€å¼‚å¸¸ã€‘ERROR_TOO_HIGH: " $0 }'
           cat $1|awk -F' ' -v col=$2 -v lower=$3 -v upper=$4 '{ if (NR>1 && $(col)<lower) print "ã€å¼‚å¸¸ã€‘ERROR_TOO_LOW: " $0 }'
           echo "ç»“æŸæ£€æŸ¥$1"
           echo
   }

é‚®ä»¶é€šçŸ¥
~~~~~~~~

.. figure:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596969990649-39907df8-9541-45fb-a3e6-8bf01a3f3c57.png#align=left&display=inline&height=353&margin=[object Object]&name=image.png&originHeight=706&originWidth=1846&size=120725&status=done&style=none&width=923
   :alt: 

.. figure:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596970024774-88c3f20c-eeec-4688-b082-2846f4fe0517.png#align=left&display=inline&height=347&margin=[object Object]&name=image.png&originHeight=694&originWidth=2010&size=121268&status=done&style=none&width=1005
   :alt: 

.. _4-é¡¹ç›®æŠ€æœ¯ç‚¹æ€»ç»“:

4 é¡¹ç›®æŠ€æœ¯ç‚¹æ€»ç»“
================

Sqoop
-----

.. _1-sqoopå¯¼å…¥å¯¼å‡ºnullå­˜å‚¨ä¸€è‡´æ€§é—®é¢˜:

(1) Sqoopå¯¼å…¥å¯¼å‡ºNullå­˜å‚¨ä¸€è‡´æ€§é—®é¢˜
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Hiveä¸­çš„Nullåœ¨åº•å±‚æ˜¯ä»¥â€œ\Nâ€æ¥å­˜å‚¨ï¼Œè€ŒMySQLä¸­çš„Nullåœ¨åº•å±‚å°±æ˜¯Nullï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¸¤ç«¯çš„ä¸€è‡´æ€§ã€‚åœ¨å¯¼å‡ºæ•°æ®æ—¶é‡‡ç”¨--input-null-stringå’Œ--input-null-non-stringä¸¤ä¸ªå‚æ•°ã€‚å¯¼å…¥æ•°æ®æ—¶é‡‡ç”¨--null-stringå’Œ--null-non-stringã€‚

.. _2-sqoopæ•°æ®å¯¼å‡ºä¸€è‡´æ€§é—®é¢˜:

(2) Sqoopæ•°æ®å¯¼å‡ºä¸€è‡´æ€§é—®é¢˜
~~~~~~~~~~~~~~~~~~~~~~~~~~~

å¦‚Sqoopåœ¨å¯¼å‡ºåˆ°Mysqlæ—¶ï¼Œä½¿ç”¨4ä¸ªMapä»»åŠ¡ï¼Œè¿‡ç¨‹ä¸­æœ‰2ä¸ªä»»åŠ¡å¤±è´¥ï¼Œé‚£æ­¤æ—¶MySQLä¸­å­˜å‚¨äº†å¦å¤–ä¸¤ä¸ªMapä»»åŠ¡å¯¼å…¥çš„æ•°æ®ã€‚

Sqoopæœ¬èº«çš„å®¹é”™ä¾èµ–äºHadoopï¼Œåœ¨Sqoopå¦‚ä½•è§£å†³ä¼ è¾“ä»»åŠ¡å¤±è´¥å¼•å‘çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚Sqoopå°†ä¸€ä¸ªä¼ è¾“ä½œä¸šç”Ÿæˆä¸€ä¸ªmapreduce
jobï¼Œä¸€ä¸ªjobæœ‰å¤šä¸ªå¹¶è¡Œæ‰§è¡Œä¼ è¾“ä½œä¸šçš„mapreduce
taskåœ¨å’Œå¤–éƒ¨æ•°æ®åº“åšæ•°æ®ä¼ è¾“ï¼Œä¸€äº›åŸå› ä¼šå¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼š

1. è¿åæ•°æ®åº“çº¦æŸ(ä¸»é”®å”¯ä¸€æ€§)ã€å­—æ®µç±»å‹ä¸ä¸€è‡´ã€æ—¶é—´åˆ†åŒºä¸ä¸€è‡´

2. æ•°æ®åº“è¿æ¥ä¸¢å¤±

3. ç”±äºåˆ†éš”ç¬¦ç­‰åŸå› ï¼Œä¼ è¾“çš„åˆ—æ•°å’Œè¡¨çš„åˆ—æ•°ä¸ä¸€è‡´

4. Hadoopæœºå™¨ç¡¬ä»¶é—®é¢˜

ä¸€ä¸ªä¼ è¾“ä»»åŠ¡ï¼Œç”±å¤šä¸ªtaskå¹¶è¡Œæ‰§è¡Œï¼Œæ¯ä¸ªtaskæœ¬èº«æ˜¯ä¸€ä¸ªtransactionï¼Œå½“è¿™ä¸ªtask
failï¼Œè¿™ä¸ªtransactionä¼šroll backï¼Œä½†å…¶ä»–çš„transactionä¸ä¼šroll
backï¼Œè¿™å°±ä¼šå¯¼è‡´éå¸¸ä¸¥é‡çš„è„æ•°æ®é—®é¢˜ï¼Œæ•°æ®éƒ¨åˆ†å¯¼å…¥ï¼Œéƒ¨åˆ†ç¼ºå¤±ï¼Œæ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿ

å¯¹äºSqoop Importä»»åŠ¡ï¼Œç”±äºHadoop CleanUp
Taskçš„å­˜åœ¨ï¼Œè¿™ä¸ªé—®é¢˜ä¸å­˜åœ¨ï¼›\ **Sqoop
Exportä»»åŠ¡åˆ™æä¾›äº†ä¸€ä¸ªâ€œä¸­é—´è¡¨â€çš„è§£å†³åŠæ³•**

å…ˆå°†æ•°æ®å†™å…¥åˆ°ä¸­é—´è¡¨ï¼Œå†™å…¥ä¸­é—´è¡¨æˆåŠŸï¼Œåœ¨ä¸€ä¸ªtransactionä¸­å°†ä¸­é—´è¡¨çš„æ•°æ®å†™å…¥ç›®æ ‡è¡¨\ **--staging-table
ä¸­é—´è¡¨\***\ \*--clear-staging-table ä»»åŠ¡å¼€å§‹å‰ï¼Œæ¸…ç©ºä¸­é—´è¡¨*\*

.. code:: shell

   sqoop export --connect jdbc:mysql://192.168.137.10:3306/user_behavior \
   --username root \
   --password 123456 \
   --table app_cource_study_report \
   --columns watch_video_cnt,complete_video_cnt,dt \
   --fields-terminated-by "\t" \
   --export-dir "/user/hive/warehouse/tmp.db/app_cource_study_analysis_${day}" \
   --staging-table app_cource_study_report_tmp \
   --clear-staging-table \
   --input-null-string '\N'

.. _3-sqoopåœ¨å¯¼å…¥æ•°æ®çš„æ—¶å€™æ•°æ®å€¾æ–œ:

(3) Sqoopåœ¨å¯¼å…¥æ•°æ®çš„æ—¶å€™æ•°æ®å€¾æ–œ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Sqoop æŠ½æ•°çš„å¹¶è¡ŒåŒ–ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªå‚æ•°ï¼š

-  num-mappersï¼šå¯åŠ¨Nä¸ªmapæ¥å¹¶è¡Œå¯¼å…¥æ•°æ®ï¼Œé»˜è®¤4ä¸ªï¼›

-  split-byï¼šæŒ‰ç…§æŸä¸€åˆ—æ¥åˆ‡åˆ†è¡¨çš„å·¥ä½œå•å…ƒ,é€šè¿‡ROWNUM()
   ç”Ÿæˆä¸€ä¸ªä¸¥æ ¼å‡åŒ€åˆ†å¸ƒçš„å­—æ®µï¼Œç„¶åæŒ‡å®šä¸ºåˆ†å‰²å­—æ®µã€‚

   -  split-by
      æ ¹æ®ä¸åŒçš„å‚æ•°ç±»å‹æœ‰ä¸åŒçš„åˆ‡åˆ†æ–¹æ³•ï¼Œå¦‚intå‹ï¼ŒSqoopä¼šå–æœ€å¤§å’Œæœ€å°split-byå­—æ®µå€¼ï¼Œç„¶åæ ¹æ®ä¼ å…¥çš„num-mappersæ¥
      ç¡®å®šåˆ’åˆ†å‡ ä¸ªåŒºåŸŸã€‚æ¯”å¦‚select max(split_by),min(split-by)
      fromå¾—åˆ°çš„max(split-by)å’Œmin(split-by)åˆ†åˆ«ä¸º1000å’Œ1ï¼Œè€Œnum-mappersï¼ˆ-mï¼‰ä¸º2çš„è¯ï¼Œåˆ™ä¼šåˆ†æˆä¸¤ä¸ªåŒºåŸŸ
      (1,500)å’Œ(501-1000),åŒæ—¶ä¹Ÿä¼šåˆ†æˆ2ä¸ªsqlç»™2ä¸ªmapå»è¿›è¡Œå¯¼å…¥æ“ä½œï¼Œåˆ†åˆ«ä¸ºselect
      XXX from table where split-by>=1 and split-by<500å’Œselect XXX from
      table where split-by>=501 and
      split-by<=1000.æœ€åæ¯ä¸ªmapå„è‡ªè·å–å„è‡ªSQLä¸­çš„æ•°æ®è¿›è¡Œå¯¼å…¥å·¥ä½œã€‚

   -  å½“split-byä¸æ˜¯intå‹æ—¶å‡ºç°å¦‚ä¸Šåœºæ™¯ä¸­çš„é—®é¢˜ã€‚ç›®å‰æƒ³åˆ°çš„è§£å†³åŠæ³•æ˜¯ï¼šå°†-m
      è®¾ç½®ç§°1ï¼Œsplit-byä¸è®¾ç½®ï¼Œå³åªæœ‰ä¸€ä¸ªmapè¿è¡Œï¼Œç¼ºç‚¹æ˜¯ä¸èƒ½å¹¶è¡Œmapå½•å…¥æ•°æ®ã€‚ï¼ˆæ³¨æ„ï¼Œå½“-m
      è®¾ç½®çš„å€¼å¤§äº1æ—¶ï¼Œsplit-byå¿…é¡»è®¾ç½®å­—æ®µï¼‰ ã€‚

   -  split-byå³ä¾¿æ˜¯intå‹ï¼Œè‹¥ä¸æ˜¯è¿ç»­æœ‰è§„å¾‹é€’å¢çš„è¯ï¼Œå„ä¸ªmapåˆ†é…çš„æ•°æ®æ˜¯ä¸å‡è¡¡çš„ï¼Œå¯èƒ½ä¼šæœ‰äº›mapå¾ˆå¿™ï¼Œæœ‰äº›mapå‡ ä¹æ²¡æœ‰æ•°æ®å¤„ç†çš„æƒ…å†µã€‚

.. code:: shell

   #!/usr/bin/bash

   #å‚æ•°é…ç½®
   exe_hive="/usr/bin/hive"

   #æŠ½å–è¡¨å
   table_name='xxx'

   #åˆ†åŒºå­—æ®µä¿¡æ¯
   master_org_id='xxx'

   if [[ $# -eq 1 ]]; then
       update_day=$1
   else
       update_day=$(date -d "1 day ago" +"%Y-%m-%d")
   fi
   echo "default_date:${update_day}"

   sqoop import -D org.apache.sqoop.splitter.allow_text_splitter=true \
   -m 4 \
   --hive-drop-import-delims \
   --fields-terminated-by '\001' \
   --connect "jdbc:oracle:thin:@xxx.xx.xx.x:1521:xxxx" \
   --username "xx" \
   --password "xx" \
   --mapreduce-job-name sqoop_${table_name} \
   --delete-target-dir \
   --split-by 'etl_id' \
   --query "
   select 
       etl_id                 ,
       DJLX                   ,
       to_char(sysdate,'yyyy-mm-dd hh24:mm:ss') as update_date,
       to_char(sysdate,'yyyy-mm-dd') as dt
   from (select 
   				row_number() OVER(order by T.SL) AS etl_id,
           T.* 
         from dbo.${table_name} T 
         where T.receivestatus = 0
   ) a  where \$CONDITIONS" \
   --target-dir /user/hive/warehouse/src.db/${table_name}/master_org_id=${master_org_id}/dt=${update_day} \
   --null-string '\\N' \
   --null-non-string '\\N' \
   -z


   HQL="
   alter table src.${table_name} add partition(master_org_id='${master_org_id}',dt='${update_day}') 
   location '/user/hive/warehouse/src.db/${table_name}/master_org_id=${master_org_id}/dt=${update_day}';
   "

   #æ‰§è¡ŒHQL
   bash ${exe_hive} -e "${HQL}"

   #åˆ¤æ–­æ•°æ®æ˜¯å¦æˆåŠŸå¯¼å…¥
   hdfs dfs -ls /user/hive/warehouse/src.db/${table_name}/master_org_id=${master_org_id}/dt=${update_day}
   if [ $? -eq 0 ] ;then 
       echo 'å¯¼å…¥æ•°æ®æˆåŠŸ'
       #åˆ é™¤Javaæ–‡ä»¶
       rm -f *.java 
   else 
       echo 'å¯¼å…¥æ•°æ®å¤±è´¥,è¯·æ£€æŸ¥ç›¸å…³æœåŠ¡'
       exit 1
   fi

.. _4-sqoopåº•å±‚è¿è¡Œçš„ä»»åŠ¡æ˜¯ä»€ä¹ˆ:

(4) Sqoopåº•å±‚è¿è¡Œçš„ä»»åŠ¡æ˜¯ä»€ä¹ˆ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

åªæœ‰Mapé˜¶æ®µï¼Œæ²¡æœ‰Reduceé˜¶æ®µçš„ä»»åŠ¡ã€‚

.. _5ï¼‰sqoopæ•°æ®å¯¼å‡ºparquet:

(5ï¼‰Sqoopæ•°æ®å¯¼å‡ºParquet
~~~~~~~~~~~~~~~~~~~~~~~~

appå±‚æ•°æ®ç”¨Sqoopå¾€MySqlä¸­å¯¼å…¥æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœç”¨äº†orcï¼ˆParquetï¼‰ä¸èƒ½å¯¼å…¥ï¼Œéœ€è½¬åŒ–æˆtextæ ¼å¼ã€‚

Hive
----

.. _1-å¤§å°è¡¨join------mapjoin:

(1) å¤§å°è¡¨Joinâ€”â€”MapJoin
~~~~~~~~~~~~~~~~~~~~~~~

å¦‚æœä¸æŒ‡å®šMapJoinæˆ–è€…ä¸ç¬¦åˆMapJoinçš„æ¡ä»¶ï¼Œé‚£ä¹ˆHiveè§£æå™¨ä¼šå°†Joinæ“ä½œè½¬æ¢æˆCommon
Joinï¼Œå³ï¼šåœ¨Reduceé˜¶æ®µå®Œæˆjoinã€‚å®¹æ˜“å‘ç”Ÿæ•°æ®å€¾æ–œã€‚å¯ä»¥ç”¨MapJoinæŠŠå°è¡¨å…¨éƒ¨åŠ è½½åˆ°å†…å­˜åœ¨mapç«¯è¿›è¡Œjoinï¼Œé¿å…reducerå¤„ç†ã€‚

å°è¡¨å…³è”ä¸€ä¸ªè¶…å¤§è¡¨æ—¶ï¼Œå®¹æ˜“å‘ç”Ÿæ•°æ®å€¾æ–œï¼Œä½¿ç”¨
``MapJoin``\ æŠŠå°è¡¨å…¨éƒ¨åŠ è½½åˆ°å†…å­˜åœ¨mapç«¯è¿›è¡Œjoinã€‚å¦‚æœéœ€è¦çš„æ•°æ®åœ¨ Map
çš„è¿‡ç¨‹ä¸­å¯ä»¥è®¿é—®åˆ°åˆ™ä¸å†éœ€è¦Reduceã€‚

åŸå§‹sqlï¼š

.. code:: sql

   select c.channel_name,count(t.requesturl) PV
   from ods.cms_channel c
   join (
     select host,requesturl 
     from  dms.tracklog_5min 
     where day='20151111'
   ) t
   on c.channel_name=t.host
   group by c.channel_name
   order by c.channel_name;

ä»¥ä¸Šä¸ºå°è¡¨joinå¤§è¡¨çš„æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨mapjoinæŠŠå°è¡¨\ ``c``\ æ”¾åˆ°å†…å­˜ä¸­å¤„ç†ï¼Œè¯­æ³•å¾ˆç®€å•åªéœ€è¦å¢åŠ 
``/*+ MAPJOIN(å°è¡¨) */``\ ï¼ŒæŠŠéœ€è¦åˆ†å‘çš„è¡¨æ”¾å…¥åˆ°å†…å­˜ä¸­ã€‚

.. code:: sql

   select /*+ MAPJOIN(c) */
   c.channel_name,count(t.requesturl) PV
   from ods.cms_channel c
   join (
     select host,requesturl 
     from  dms.tracklog_5min 
     where day='20151111'
   ) t
   on c.channel_name=t.host
   group by c.channel_name
   order by c.channel_name;

.. _2-è¡Œåˆ—è¿‡æ»¤:

(2) è¡Œåˆ—è¿‡æ»¤
~~~~~~~~~~~~

-  åˆ—å¤„ç†ï¼šåœ¨SELECTä¸­ï¼Œåªæ‹¿éœ€è¦çš„åˆ—ï¼Œå¦‚æœæœ‰ï¼Œå°½é‡ä½¿ç”¨åˆ†åŒºè¿‡æ»¤ï¼Œå°‘ç”¨SELECT
   \*ã€‚

-  è¡Œå¤„ç†ï¼šåœ¨åˆ†åŒºå‰ªè£ä¸­ï¼Œå½“ä½¿ç”¨å¤–å…³è”æ—¶ï¼Œå¦‚æœå°†å‰¯è¡¨çš„è¿‡æ»¤æ¡ä»¶å†™åœ¨Whereåé¢ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆå…¨è¡¨å…³è”ï¼Œä¹‹åå†è¿‡æ»¤ã€‚

.. _3-åˆç†è®¾ç½®mapæ•°:

(3) åˆç†è®¾ç½®Mapæ•°
~~~~~~~~~~~~~~~~~

-  ï¼ˆ1ï¼‰é€šå¸¸æƒ…å†µä¸‹ï¼Œä½œä¸šä¼šé€šè¿‡inputçš„ç›®å½•äº§ç”Ÿä¸€ä¸ªæˆ–è€…å¤šä¸ªmapä»»åŠ¡ã€‚

ä¸»è¦çš„å†³å®šå› ç´ æœ‰ï¼šinputçš„æ–‡ä»¶æ€»ä¸ªæ•°ï¼Œinputçš„æ–‡ä»¶å¤§å°ï¼Œé›†ç¾¤è®¾ç½®çš„æ–‡ä»¶å—å¤§å°ã€‚

-  ï¼ˆ2ï¼‰æ˜¯ä¸æ˜¯mapæ•°è¶Šå¤šè¶Šå¥½ï¼Ÿ

ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚å¦‚æœä¸€ä¸ªä»»åŠ¡æœ‰å¾ˆå¤šå°æ–‡ä»¶ï¼ˆè¿œè¿œå°äºå—å¤§å°128mï¼‰ï¼Œåˆ™æ¯ä¸ªå°æ–‡ä»¶ä¹Ÿä¼šè¢«å½“åšä¸€ä¸ªå—ï¼Œç”¨ä¸€ä¸ªmapä»»åŠ¡æ¥å®Œæˆï¼Œè€Œä¸€ä¸ªmapä»»åŠ¡å¯åŠ¨å’Œåˆå§‹åŒ–çš„æ—¶é—´è¿œè¿œå¤§äºé€»è¾‘å¤„ç†çš„æ—¶é—´ï¼Œå°±ä¼šé€ æˆå¾ˆå¤§çš„èµ„æºæµªè´¹ã€‚è€Œä¸”ï¼ŒåŒæ—¶å¯æ‰§è¡Œçš„mapæ•°æ˜¯å—é™çš„ã€‚

-  ï¼ˆ3ï¼‰æ˜¯ä¸æ˜¯ä¿è¯æ¯ä¸ªmapå¤„ç†æ¥è¿‘128mçš„æ–‡ä»¶å—ï¼Œå°±é«˜æ•æ— å¿§äº†ï¼Ÿ

ç­”æ¡ˆä¹Ÿæ˜¯ä¸ä¸€å®šã€‚æ¯”å¦‚æœ‰ä¸€ä¸ª127mçš„æ–‡ä»¶ï¼Œæ­£å¸¸ä¼šç”¨ä¸€ä¸ªmapå»å®Œæˆï¼Œä½†è¿™ä¸ªæ–‡ä»¶åªæœ‰ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå°å­—æ®µï¼Œå´æœ‰å‡ åƒä¸‡çš„è®°å½•ï¼Œå¦‚æœmapå¤„ç†çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œç”¨ä¸€ä¸ªmapä»»åŠ¡å»åšï¼Œè‚¯å®šä¹Ÿæ¯”è¾ƒè€—æ—¶ã€‚

**é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜2å’Œ3ï¼Œæˆ‘ä»¬éœ€è¦é‡‡å–ä¸¤ç§æ–¹å¼æ¥è§£å†³ï¼šå³å‡å°‘mapæ•°å’Œå¢åŠ mapæ•°**

.. _4-hiveå°æ–‡ä»¶åˆå¹¶:

(4) Hiveå°æ–‡ä»¶åˆå¹¶
~~~~~~~~~~~~~~~~~~

Hiveçš„åç«¯å­˜å‚¨æ˜¯HDFSï¼Œå®ƒå¯¹å¤§æ–‡ä»¶çš„å¤„ç†æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œå¦‚æœåˆç†é…ç½®æ–‡ä»¶ç³»ç»Ÿçš„å—å¤§å°ï¼ŒNameNodeå¯ä»¥æ”¯æŒå¾ˆå¤§çš„æ•°æ®é‡ã€‚ä½†æ˜¯åœ¨æ•°æ®ä»“åº“ä¸­ï¼Œè¶Šæ˜¯ä¸Šå±‚çš„è¡¨å…¶æ±‡æ€»ç¨‹åº¦å°±è¶Šé«˜ï¼Œæ•°æ®é‡ä¹Ÿå°±è¶Šå°ã€‚è€Œä¸”è¿™äº›è¡¨é€šå¸¸ä¼šæŒ‰æ—¥æœŸè¿›è¡Œåˆ†åŒºï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼ŒHDFSçš„æ–‡ä»¶æ•°ç›®å°±ä¼šé€æ¸å¢åŠ ã€‚

-  å°æ–‡ä»¶å¸¦æ¥çš„é—®é¢˜

ç®€å•æ¥è¯´ï¼ŒHDFSçš„æ–‡ä»¶å…ƒä¿¡æ¯ï¼ŒåŒ…æ‹¬ä½ç½®ã€å¤§å°ã€åˆ†å—ä¿¡æ¯ç­‰ï¼Œéƒ½æ˜¯ä¿å­˜åœ¨NameNodeçš„å†…å­˜ä¸­çš„ã€‚æ¯ä¸ªå¯¹è±¡å¤§çº¦å ç”¨150ä¸ªå­—èŠ‚ï¼Œå› æ­¤1000ä¸‡ä¸ªæ–‡ä»¶åŠåˆ†å—å°±ä¼šå ç”¨çº¦3Gçš„å†…å­˜ç©ºé—´ï¼Œä¸€æ—¦æ¥è¿‘è¿™ä¸ªé‡çº§ï¼ŒNameNodeçš„æ€§èƒ½å°±ä¼šå¼€å§‹ä¸‹é™äº†ã€‚

æ­¤å¤–ï¼ŒHDFSè¯»å†™å°æ–‡ä»¶æ—¶ä¹Ÿä¼šæ›´åŠ è€—æ—¶ï¼Œå› ä¸ºæ¯æ¬¡éƒ½éœ€è¦ä»NameNodeè·å–å…ƒä¿¡æ¯ï¼Œå¹¶ä¸å¯¹åº”çš„DataNodeå»ºç«‹è¿æ¥ã€‚å¯¹äºMapReduceç¨‹åºæ¥è¯´ï¼Œå°æ–‡ä»¶è¿˜ä¼šå¢åŠ Mapperçš„ä¸ªæ•°ï¼Œæ¯ä¸ªè„šæœ¬åªå¤„ç†å¾ˆå°‘çš„æ•°æ®ï¼Œæµªè´¹äº†å¤§é‡çš„è°ƒåº¦æ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡ä½¿ç”¨CombinedInputFileå’ŒJVMé‡ç”¨æ¥è§£å†³ã€‚

-  Hiveå°æ–‡ä»¶äº§ç”Ÿçš„åŸå› 

å‰é¢å·²ç»æåˆ°ï¼Œæ±‡æ€»åçš„æ•°æ®é‡é€šå¸¸æ¯”æºæ•°æ®è¦å°‘å¾—å¤šã€‚è€Œä¸ºäº†æå‡è¿ç®—é€Ÿåº¦ï¼Œæˆ‘ä»¬ä¼šå¢åŠ Reducerçš„æ•°é‡ï¼ŒHiveæœ¬èº«ä¹Ÿä¼šåšç±»ä¼¼ä¼˜åŒ–â€”â€”Reduceræ•°é‡ç­‰äºæºæ•°æ®çš„é‡é™¤ä»¥hive.exec.reducers.bytes.per.reduceræ‰€é…ç½®çš„é‡ï¼ˆé»˜è®¤1Gï¼‰ã€‚Reduceræ•°é‡çš„å¢åŠ ä¹Ÿå³æ„å‘³ç€ç»“æœæ–‡ä»¶çš„å¢åŠ ï¼Œä»è€Œäº§ç”Ÿå°æ–‡ä»¶çš„é—®é¢˜ã€‚

è§£å†³å°æ–‡ä»¶çš„é—®é¢˜å¯ä»¥ä»ä¸¤ä¸ªæ–¹å‘å…¥æ‰‹ï¼š\ **1. è¾“å…¥åˆå¹¶ã€‚å³åœ¨Mapå‰åˆå¹¶å°æ–‡ä»¶
2. è¾“å‡ºåˆå¹¶ã€‚å³åœ¨è¾“å‡ºç»“æœçš„æ—¶å€™åˆå¹¶å°æ–‡ä»¶**

-  é…ç½®Mapè¾“å…¥åˆå¹¶

.. code:: shell

   set mapred.max.split.size=256000000; -- æ¯ä¸ªMapæœ€å¤§è¾“å…¥å¤§å°ï¼Œå†³å®šåˆå¹¶åçš„æ–‡ä»¶æ•°
   set mapred.min.split.size.per.node=100000000; -- ä¸€ä¸ªèŠ‚ç‚¹ä¸Šsplitçš„è‡³å°‘çš„å¤§å° ï¼Œå†³å®šäº†å¤šä¸ªdata nodeä¸Šçš„æ–‡ä»¶æ˜¯å¦éœ€è¦åˆå¹¶
   set mapred.min.split.size.per.rack=100000000; -- ä¸€ä¸ªäº¤æ¢æœºä¸‹splitçš„è‡³å°‘çš„å¤§å°ï¼Œå†³å®šäº†å¤šä¸ªäº¤æ¢æœºä¸Šçš„æ–‡ä»¶æ˜¯å¦éœ€è¦åˆå¹¶
   set hive.input.format=org.apache.hadoop.hive.ql.io.CombineHiveInputFormat; -- æ‰§è¡ŒMapå‰è¿›è¡Œå°æ–‡ä»¶åˆå¹¶

-  é…ç½®Mapè¾“å‡ºåˆå¹¶

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›é…ç½®é¡¹æ¥ä½¿Hiveåœ¨æ‰§è¡Œç»“æŸåå¯¹ç»“æœæ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼š

.. code:: shell

   # è¾“å‡ºåˆå¹¶å°æ–‡ä»¶
   set hive.merge.mapfiles = true; -- é»˜è®¤trueï¼Œåœ¨map-onlyä»»åŠ¡ç»“æŸæ—¶åˆå¹¶å°æ–‡ä»¶
   set hive.merge.mapredfiles = true; -- é»˜è®¤falseï¼Œåœ¨map-reduceä»»åŠ¡ç»“æŸæ—¶åˆå¹¶å°æ–‡ä»¶
   set hive.merge.size.per.task = 268435456; -- é»˜è®¤256M
   set hive.merge.smallfiles.avgsize = 16777216; -- å½“è¾“å‡ºæ–‡ä»¶çš„å¹³å‡å¤§å°å°äºè¯¥å€¼æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªç‹¬ç«‹çš„map-reduceä»»åŠ¡è¿›è¡Œæ–‡ä»¶merge

.. _5-åˆç†è®¾ç½®reduceæ•°:

(5) åˆç†è®¾ç½®Reduceæ•°
~~~~~~~~~~~~~~~~~~~~

Reduceä¸ªæ•°å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½

-  è¿‡å¤šçš„å¯åŠ¨å’Œåˆå§‹åŒ–Reduceä¹Ÿä¼šæ¶ˆè€—æ—¶é—´å’Œèµ„æºï¼›

-  å¦å¤–ï¼Œæœ‰å¤šå°‘ä¸ªReduceï¼Œå°±ä¼šæœ‰å¤šå°‘ä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œå¦‚æœç”Ÿæˆäº†å¾ˆå¤šä¸ªå°æ–‡ä»¶ï¼Œé‚£ä¹ˆå¦‚æœè¿™äº›å°æ–‡ä»¶ä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡çš„è¾“å…¥ï¼Œåˆ™ä¹Ÿä¼šå‡ºç°å°æ–‡ä»¶è¿‡å¤šçš„é—®é¢˜ï¼›

åœ¨è®¾ç½®Reduceä¸ªæ•°çš„æ—¶å€™ä¹Ÿéœ€è¦è€ƒè™‘è¿™ä¸¤ä¸ªåŸåˆ™ï¼šå¤„ç†å¤§æ•°æ®é‡åˆ©ç”¨åˆé€‚çš„Reduceæ•°ï¼›ä½¿å•ä¸ªReduceä»»åŠ¡å¤„ç†æ•°æ®é‡å¤§å°è¦åˆé€‚ï¼›

.. _6-hiveå…ƒæ•°æ®çš„å®‰å…¨æ€§:

(6) Hiveå…ƒæ•°æ®çš„å®‰å…¨æ€§
~~~~~~~~~~~~~~~~~~~~~~

Hiveçš„metadataå­˜å‚¨åœ¨MySQLä¸­ï¼Œéœ€è¦é…ç½®MySQLçš„é«˜å¯ç”¨ï¼ˆä¸»ä»å¤åˆ¶å’Œè¯»å†™åˆ†ç¦»å’Œæ•…éšœè½¬ç§»ï¼‰ã€‚

Spark
-----

.. _1-sparkçš„æ¶æ„ä¸ä½œä¸šæäº¤æµç¨‹:

(1) Sparkçš„æ¶æ„ä¸ä½œä¸šæäº¤æµç¨‹
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-  Yarnæ¨¡å¼: |image3|

-  RDD: RDDåœ¨Lineageä¾èµ–æ–¹é¢åˆ†ä¸ºä¸¤ç§Narrow Dependenciesä¸Wide
   Dependenciesç”¨æ¥è§£å†³æ•°æ®å®¹é”™æ—¶çš„é«˜æ•ˆæ€§ä»¥åŠåˆ’åˆ†ä»»åŠ¡æ—¶å€™èµ·åˆ°é‡è¦ä½œç”¨ã€‚

-  Sparkçš„å®½çª„ä¾èµ–ï¼Œä»¥åŠSparkå¦‚ä½•åˆ’åˆ†stageï¼Œæ¯ä¸ªstageåˆæ ¹æ®ä»€ä¹ˆå†³å®štaskä¸ªæ•°:
   Stageï¼šæ ¹æ®RDDä¹‹é—´çš„ä¾èµ–å…³ç³»çš„ä¸åŒå°†Jobåˆ’åˆ†æˆä¸åŒçš„Stageï¼Œé‡åˆ°ä¸€ä¸ªå®½ä¾èµ–åˆ™åˆ’åˆ†ä¸€ä¸ªStageã€‚
   Taskï¼šStageæ˜¯ä¸€ä¸ªTaskSetï¼Œå°†Stageæ ¹æ®åˆ†åŒºæ•°åˆ’åˆ†æˆä¸€ä¸ªä¸ªçš„Taskã€‚

-  Sparkä¸­çš„ç¼“å­˜æœºåˆ¶ï¼ˆcacheå’Œpersistï¼‰ä¸checkpointæœºåˆ¶ï¼š
   è¿™ä¸¤ä¸ªéƒ½æ˜¯åšRDDæŒä¹…åŒ–çš„,
   cache:å†…å­˜ï¼Œä¸ä¼šæˆªæ–­è¡€ç¼˜å…³ç³»ï¼Œä½¿ç”¨è®¡ç®—è¿‡ç¨‹ä¸­çš„æ•°æ®ç¼“å­˜ã€‚
   checkpointï¼šç£ç›˜ï¼Œæˆªæ–­è¡€ç¼˜å…³ç³»ï¼Œåœ¨ckä¹‹å‰å¿…é¡»æ²¡æœ‰ä»»ä½•ä»»åŠ¡æäº¤æ‰ä¼šç”Ÿæ•ˆï¼Œckè¿‡ç¨‹ä¼šé¢å¤–æäº¤ä¸€æ¬¡ä»»åŠ¡ã€‚

.. _2-repartitionå’Œcoalesceå…³ç³»ä¸åŒºåˆ«:

(2) Repartitionå’ŒCoalesceå…³ç³»ä¸åŒºåˆ«
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-  1ï¼‰å…³ç³»ï¼š

ä¸¤è€…éƒ½æ˜¯ç”¨æ¥æ”¹å˜RDDçš„partitionæ•°é‡çš„ï¼Œrepartitionåº•å±‚è°ƒç”¨çš„å°±æ˜¯coalesceæ–¹æ³•ï¼šcoalesce(numPartitions,
shuffle = true)ã€‚

-  2ï¼‰åŒºåˆ«ï¼š

repartitionä¸€å®šä¼šå‘ç”Ÿshuffleï¼Œcoalesceæ ¹æ®ä¼ å…¥çš„å‚æ•°æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿshuffleã€‚ä¸€èˆ¬æƒ…å†µä¸‹å¢å¤§rddçš„partitionæ•°é‡ä½¿ç”¨repartitionï¼Œå‡å°‘partitionæ•°é‡æ—¶ä½¿ç”¨coalesceã€‚

.. _3-å½“sparkæ¶‰åŠåˆ°æ•°æ®åº“çš„æ“ä½œæ—¶å¦‚ä½•å‡å°‘sparkè¿è¡Œä¸­çš„æ•°æ®åº“è¿æ¥æ•°:

(3) å½“Sparkæ¶‰åŠåˆ°æ•°æ®åº“çš„æ“ä½œæ—¶ï¼Œå¦‚ä½•å‡å°‘Sparkè¿è¡Œä¸­çš„æ•°æ®åº“è¿æ¥æ•°ï¼Ÿ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

ä½¿ç”¨foreachPartitionä»£æ›¿foreachï¼Œåœ¨foreachPartitionå†…è·å–æ•°æ®åº“çš„è¿æ¥ã€‚

.. _4-spark-shuffle:

(4) Spark Shuffle
~~~~~~~~~~~~~~~~~

æˆ‘ä»¬çŸ¥é“åœ¨è¿›è¡Œshuffleçš„æ—¶å€™ä¼šå°†å„ä¸ªèŠ‚ç‚¹ä¸Škeyç›¸åŒçš„æ•°æ®ä¼ è¾“åˆ°åŒä¸€ç»“ç‚¹è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚å¦‚æœæŸä¸ªkeyæˆ–æŸå‡ ä¸ªkeyä¸‹çš„æ•°æ®çš„æ•°æ®é‡ç‰¹åˆ«å¤§ï¼Œè¿œè¿œå¤§äºå…¶ä»–keyçš„æ•°æ®ï¼Œè¿™æ—¶å°±ä¼šå‡ºç°ä¸€ä¸ªç°è±¡ï¼Œå¤§éƒ¨åˆ†taskå¾ˆå¿«å°±å®Œæˆç»“æŸï¼Œå‰©ä¸‹å‡ ä¸ªtaskè¿è¡Œç‰¹åˆ«ç¼“æ…¢ã€‚ç”šè‡³æœ‰æ—¶å€™è¿˜ä¼šå› ä¸ºæŸä¸ªtaskä¸‹ç›¸åŒkeyçš„æ•°æ®é‡è¿‡å¤§è€Œé€ æˆå†…å­˜æº¢å‡ºã€‚è¿™å°±æ˜¯å‘ç”Ÿäº†æ•°æ®å€¾æ–œã€‚

-  è°ƒæ•´åˆ†åŒºæ•°ç›®

-  å»é™¤ç©ºå€¼å¤šä½™æ•°æ®

-  ä½¿ç”¨å¹¿æ’­å°†reduce join è½¬åŒ–ä¸ºmap join

-  å°†keyè¿›è¡Œæ‹†åˆ†ï¼Œå¤§æ•°æ®åŒ–å°æ•°æ®

-  èµ„æºå‚æ•°è°ƒä¼˜

.. _5-sparkèµ„æºå‚æ•°:

(5) Sparkèµ„æºå‚æ•°
~~~~~~~~~~~~~~~~~

å¯¹Sparkè¿è¡Œè¿‡ç¨‹ä¸­å„ä¸ªä½¿ç”¨èµ„æºçš„åœ°æ–¹ï¼Œé€šè¿‡è°ƒèŠ‚å„ç§å‚æ•°ï¼Œæ¥ä¼˜åŒ–èµ„æºä½¿ç”¨çš„æ•ˆç‡ï¼Œä»è€Œæå‡Sparkä½œä¸šçš„æ‰§è¡Œæ€§èƒ½ã€‚ä»¥ä¸‹å‚æ•°å°±æ˜¯Sparkä¸­ä¸»è¦çš„èµ„æºå‚æ•°ã€‚

ï¼ˆ1ï¼‰num-executors

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®Sparkä½œä¸šæ€»å…±è¦ç”¨å¤šå°‘ä¸ªExecutorè¿›ç¨‹æ¥æ‰§è¡Œã€‚Driveråœ¨å‘YARNé›†ç¾¤ç®¡ç†å™¨ç”³è¯·èµ„æºæ—¶ï¼ŒYARNé›†ç¾¤ç®¡ç†å™¨ä¼šå°½å¯èƒ½æŒ‰ç…§ä½ çš„è®¾ç½®æ¥åœ¨é›†ç¾¤çš„å„ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œå¯åŠ¨ç›¸åº”æ•°é‡çš„Executorè¿›ç¨‹ã€‚è¿™ä¸ªå‚æ•°éå¸¸ä¹‹é‡è¦ï¼Œå¦‚æœä¸è®¾ç½®çš„è¯ï¼Œé»˜è®¤åªä¼šç»™ä½ å¯åŠ¨å°‘é‡çš„Executorè¿›ç¨‹ï¼Œæ­¤æ—¶ä½ çš„Sparkä½œä¸šçš„è¿è¡Œé€Ÿåº¦æ˜¯éå¸¸æ…¢çš„ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šæ¯ä¸ªSparkä½œä¸šçš„è¿è¡Œä¸€èˆ¬è®¾ç½®50~100ä¸ªå·¦å³çš„Executorè¿›ç¨‹æ¯”è¾ƒåˆé€‚ï¼Œè®¾ç½®å¤ªå°‘æˆ–å¤ªå¤šçš„Executorè¿›ç¨‹éƒ½ä¸å¥½ã€‚è®¾ç½®çš„å¤ªå°‘ï¼Œæ— æ³•å……åˆ†åˆ©ç”¨é›†ç¾¤èµ„æºï¼›è®¾ç½®çš„å¤ªå¤šçš„è¯ï¼Œå¤§éƒ¨åˆ†é˜Ÿåˆ—å¯èƒ½æ— æ³•ç»™äºˆå……åˆ†çš„èµ„æºã€‚

ï¼ˆ2ï¼‰executor-memory

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®æ¯ä¸ªExecutorè¿›ç¨‹çš„å†…å­˜ã€‚Executorå†…å­˜çš„å¤§å°ï¼Œå¾ˆå¤šæ—¶å€™ç›´æ¥å†³å®šäº†Sparkä½œä¸šçš„æ€§èƒ½ï¼Œè€Œä¸”è·Ÿå¸¸è§çš„JVM
   OOMå¼‚å¸¸ï¼Œä¹Ÿæœ‰ç›´æ¥çš„å…³è”ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šæ¯ä¸ªExecutorè¿›ç¨‹çš„å†…å­˜è®¾ç½®4G~8Gè¾ƒä¸ºåˆé€‚ã€‚ä½†æ˜¯è¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜æ˜¯å¾—æ ¹æ®ä¸åŒéƒ¨é—¨çš„èµ„æºé˜Ÿåˆ—æ¥å®šã€‚å¯ä»¥çœ‹çœ‹è‡ªå·±å›¢é˜Ÿçš„èµ„æºé˜Ÿåˆ—çš„æœ€å¤§å†…å­˜é™åˆ¶æ˜¯å¤šå°‘ï¼Œnum-executorsä¹˜ä»¥executor-memoryï¼Œæ˜¯ä¸èƒ½è¶…è¿‡é˜Ÿåˆ—çš„æœ€å¤§å†…å­˜é‡çš„ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ æ˜¯è·Ÿå›¢é˜Ÿé‡Œå…¶ä»–äººå…±äº«è¿™ä¸ªèµ„æºé˜Ÿåˆ—ï¼Œé‚£ä¹ˆç”³è¯·çš„å†…å­˜é‡æœ€å¥½ä¸è¦è¶…è¿‡èµ„æºé˜Ÿåˆ—æœ€å¤§æ€»å†…å­˜çš„1/3~1/2ï¼Œé¿å…ä½ è‡ªå·±çš„Sparkä½œä¸šå ç”¨äº†é˜Ÿåˆ—æ‰€æœ‰çš„èµ„æºï¼Œå¯¼è‡´åˆ«çš„åŒå­¦çš„ä½œä¸šæ— æ³•è¿è¡Œã€‚

ï¼ˆ3ï¼‰executor-cores

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®æ¯ä¸ªExecutorè¿›ç¨‹çš„CPU
   coreæ•°é‡ã€‚è¿™ä¸ªå‚æ•°å†³å®šäº†æ¯ä¸ªExecutorè¿›ç¨‹å¹¶è¡Œæ‰§è¡Œtaskçº¿ç¨‹çš„èƒ½åŠ›ã€‚å› ä¸ºæ¯ä¸ªCPU
   coreåŒä¸€æ—¶é—´åªèƒ½æ‰§è¡Œä¸€ä¸ªtaskçº¿ç¨‹ï¼Œå› æ­¤æ¯ä¸ªExecutorè¿›ç¨‹çš„CPU
   coreæ•°é‡è¶Šå¤šï¼Œè¶Šèƒ½å¤Ÿå¿«é€Ÿåœ°æ‰§è¡Œå®Œåˆ†é…ç»™è‡ªå·±çš„æ‰€æœ‰taskçº¿ç¨‹ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šExecutorçš„CPU
   coreæ•°é‡è®¾ç½®ä¸º2~4ä¸ªè¾ƒä¸ºåˆé€‚ã€‚åŒæ ·å¾—æ ¹æ®ä¸åŒéƒ¨é—¨çš„èµ„æºé˜Ÿåˆ—æ¥å®šï¼Œå¯ä»¥çœ‹çœ‹è‡ªå·±çš„èµ„æºé˜Ÿåˆ—çš„æœ€å¤§CPU
   coreé™åˆ¶æ˜¯å¤šå°‘ï¼Œå†ä¾æ®è®¾ç½®çš„Executoræ•°é‡ï¼Œæ¥å†³å®šæ¯ä¸ªExecutorè¿›ç¨‹å¯ä»¥åˆ†é…åˆ°å‡ ä¸ªCPU
   coreã€‚åŒæ ·å»ºè®®ï¼Œå¦‚æœæ˜¯è·Ÿä»–äººå…±äº«è¿™ä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆnum-executors \*
   executor-coresä¸è¦è¶…è¿‡é˜Ÿåˆ—æ€»CPU
   coreçš„1/3~1/2å·¦å³æ¯”è¾ƒåˆé€‚ï¼Œä¹Ÿæ˜¯é¿å…å½±å“å…¶ä»–åŒå­¦çš„ä½œä¸šè¿è¡Œã€‚

ï¼ˆ4ï¼‰driver-memory

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®Driverè¿›ç¨‹çš„å†…å­˜ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šDriverçš„å†…å­˜é€šå¸¸æ¥è¯´ä¸è®¾ç½®ï¼Œæˆ–è€…è®¾ç½®1Gå·¦å³åº”è¯¥å°±å¤Ÿäº†ã€‚å”¯ä¸€éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨collectç®—å­å°†RDDçš„æ•°æ®å…¨éƒ¨æ‹‰å–åˆ°Driverä¸Šè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆå¿…é¡»ç¡®ä¿Driverçš„å†…å­˜è¶³å¤Ÿå¤§ï¼Œå¦åˆ™ä¼šå‡ºç°OOMå†…å­˜æº¢å‡ºçš„é—®é¢˜ã€‚

ï¼ˆ5ï¼‰spark.default.parallelism

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®æ¯ä¸ªstageçš„é»˜è®¤taskæ•°é‡ã€‚è¿™ä¸ªå‚æ•°æä¸ºé‡è¦ï¼Œå¦‚æœä¸è®¾ç½®å¯èƒ½ä¼šç›´æ¥å½±å“ä½ çš„Sparkä½œä¸šæ€§èƒ½ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šSparkä½œä¸šçš„é»˜è®¤taskæ•°é‡ä¸º500~1000ä¸ªè¾ƒä¸ºåˆé€‚ã€‚å¾ˆå¤šåŒå­¦å¸¸çŠ¯çš„ä¸€ä¸ªé”™è¯¯å°±æ˜¯ä¸å»è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šå¯¼è‡´Sparkè‡ªå·±æ ¹æ®åº•å±‚HDFSçš„blockæ•°é‡æ¥è®¾ç½®taskçš„æ•°é‡ï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªHDFS
   blockå¯¹åº”ä¸€ä¸ªtaskã€‚é€šå¸¸æ¥è¯´ï¼ŒSparké»˜è®¤è®¾ç½®çš„æ•°é‡æ˜¯åå°‘çš„ï¼ˆæ¯”å¦‚å°±å‡ åä¸ªtaskï¼‰ï¼Œå¦‚æœtaskæ•°é‡åå°‘çš„è¯ï¼Œå°±ä¼šå¯¼è‡´ä½ å‰é¢è®¾ç½®å¥½çš„Executorçš„å‚æ•°éƒ½å‰åŠŸå°½å¼ƒã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œæ— è®ºä½ çš„Executorè¿›ç¨‹æœ‰å¤šå°‘ä¸ªï¼Œå†…å­˜å’ŒCPUæœ‰å¤šå¤§ï¼Œä½†æ˜¯taskåªæœ‰1ä¸ªæˆ–è€…10ä¸ªï¼Œé‚£ä¹ˆ90%çš„Executorè¿›ç¨‹å¯èƒ½æ ¹æœ¬å°±æ²¡æœ‰taskæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ç™½ç™½æµªè´¹äº†èµ„æºï¼å› æ­¤Sparkå®˜ç½‘å»ºè®®çš„è®¾ç½®åŸåˆ™æ˜¯ï¼Œè®¾ç½®è¯¥å‚æ•°ä¸ºnum-executors
   \* executor-coresçš„2~3å€è¾ƒä¸ºåˆé€‚ï¼Œæ¯”å¦‚Executorçš„æ€»CPU
   coreæ•°é‡ä¸º300ä¸ªï¼Œé‚£ä¹ˆè®¾ç½®1000ä¸ªtaskæ˜¯å¯ä»¥çš„ï¼Œæ­¤æ—¶å¯ä»¥å……åˆ†åœ°åˆ©ç”¨Sparké›†ç¾¤çš„èµ„æºã€‚

ï¼ˆ6ï¼‰spark.storage.memoryFraction

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®RDDæŒä¹…åŒ–æ•°æ®åœ¨Executorå†…å­˜ä¸­èƒ½å çš„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯0.6ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤Executor
   60%çš„å†…å­˜ï¼Œå¯ä»¥ç”¨æ¥ä¿å­˜æŒä¹…åŒ–çš„RDDæ•°æ®ã€‚æ ¹æ®ä½ é€‰æ‹©çš„ä¸åŒçš„æŒä¹…åŒ–ç­–ç•¥ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿæ—¶ï¼Œå¯èƒ½æ•°æ®å°±ä¸ä¼šæŒä¹…åŒ–ï¼Œæˆ–è€…æ•°æ®ä¼šå†™å…¥ç£ç›˜ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šå¦‚æœSparkä½œä¸šä¸­ï¼Œæœ‰è¾ƒå¤šçš„RDDæŒä¹…åŒ–æ“ä½œï¼Œè¯¥å‚æ•°çš„å€¼å¯ä»¥é€‚å½“æé«˜ä¸€äº›ï¼Œä¿è¯æŒä¹…åŒ–çš„æ•°æ®èƒ½å¤Ÿå®¹çº³åœ¨å†…å­˜ä¸­ã€‚é¿å…å†…å­˜ä¸å¤Ÿç¼“å­˜æ‰€æœ‰çš„æ•°æ®ï¼Œå¯¼è‡´æ•°æ®åªèƒ½å†™å…¥ç£ç›˜ä¸­ï¼Œé™ä½äº†æ€§èƒ½ã€‚ä½†æ˜¯å¦‚æœSparkä½œä¸šä¸­çš„shuffleç±»æ“ä½œæ¯”è¾ƒå¤šï¼Œè€ŒæŒä¹…åŒ–æ“ä½œæ¯”è¾ƒå°‘ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°çš„å€¼é€‚å½“é™ä½ä¸€äº›æ¯”è¾ƒåˆé€‚ã€‚æ­¤å¤–ï¼Œå¦‚æœå‘ç°ä½œä¸šç”±äºé¢‘ç¹çš„gcå¯¼è‡´è¿è¡Œç¼“æ…¢ï¼ˆé€šè¿‡spark
   web
   uiå¯ä»¥è§‚å¯Ÿåˆ°ä½œä¸šçš„gcè€—æ—¶ï¼‰ï¼Œæ„å‘³ç€taskæ‰§è¡Œç”¨æˆ·ä»£ç çš„å†…å­˜ä¸å¤Ÿç”¨ï¼Œé‚£ä¹ˆåŒæ ·å»ºè®®è°ƒä½è¿™ä¸ªå‚æ•°çš„å€¼ã€‚

ï¼ˆ7ï¼‰spark.shuffle.memoryFraction

-  å‚æ•°è¯´æ˜ï¼šè¯¥å‚æ•°ç”¨äºè®¾ç½®shuffleè¿‡ç¨‹ä¸­ä¸€ä¸ªtaskæ‹‰å–åˆ°ä¸Šä¸ªstageçš„taskçš„è¾“å‡ºåï¼Œè¿›è¡Œèšåˆæ“ä½œæ—¶èƒ½å¤Ÿä½¿ç”¨çš„Executorå†…å­˜çš„æ¯”ä¾‹ï¼Œé»˜è®¤æ˜¯0.2ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒExecutoré»˜è®¤åªæœ‰20%çš„å†…å­˜ç”¨æ¥è¿›è¡Œè¯¥æ“ä½œã€‚shuffleæ“ä½œåœ¨è¿›è¡Œèšåˆæ—¶ï¼Œå¦‚æœå‘ç°ä½¿ç”¨çš„å†…å­˜è¶…å‡ºäº†è¿™ä¸ª20%çš„é™åˆ¶ï¼Œé‚£ä¹ˆå¤šä½™çš„æ•°æ®å°±ä¼šæº¢å†™åˆ°ç£ç›˜æ–‡ä»¶ä¸­å»ï¼Œæ­¤æ—¶å°±ä¼šæå¤§åœ°é™ä½æ€§èƒ½ã€‚

-  å‚æ•°è°ƒä¼˜å»ºè®®ï¼šå¦‚æœSparkä½œä¸šä¸­çš„RDDæŒä¹…åŒ–æ“ä½œè¾ƒå°‘ï¼Œshuffleæ“ä½œè¾ƒå¤šæ—¶ï¼Œå»ºè®®é™ä½æŒä¹…åŒ–æ“ä½œçš„å†…å­˜å æ¯”ï¼Œæé«˜shuffleæ“ä½œçš„å†…å­˜å æ¯”æ¯”ä¾‹ï¼Œé¿å…shuffleè¿‡ç¨‹ä¸­æ•°æ®è¿‡å¤šæ—¶å†…å­˜ä¸å¤Ÿç”¨ï¼Œå¿…é¡»æº¢å†™åˆ°ç£ç›˜ä¸Šï¼Œé™ä½äº†æ€§èƒ½ã€‚æ­¤å¤–ï¼Œå¦‚æœå‘ç°ä½œä¸šç”±äºé¢‘ç¹çš„gcå¯¼è‡´è¿è¡Œç¼“æ…¢ï¼Œæ„å‘³ç€taskæ‰§è¡Œç”¨æˆ·ä»£ç çš„å†…å­˜ä¸å¤Ÿç”¨ï¼Œé‚£ä¹ˆåŒæ ·å»ºè®®è°ƒä½è¿™ä¸ªå‚æ•°çš„å€¼ã€‚

èµ„æºå‚æ•°çš„è°ƒä¼˜ï¼Œæ²¡æœ‰ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œéœ€è¦åŒå­¦ä»¬æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µï¼ˆåŒ…æ‹¬Sparkä½œä¸šä¸­çš„shuffleæ“ä½œæ•°é‡ã€RDDæŒä¹…åŒ–æ“ä½œæ•°é‡ä»¥åŠspark
web
uiä¸­æ˜¾ç¤ºçš„ä½œä¸šgcæƒ…å†µï¼‰ï¼ŒåŒæ—¶å‚è€ƒæœ¬ç¯‡æ–‡ç« ä¸­ç»™å‡ºçš„åŸç†ä»¥åŠè°ƒä¼˜å»ºè®®ï¼Œåˆç†åœ°è®¾ç½®ä¸Šè¿°å‚æ•°ã€‚

åœ¨æäº¤ä»»åŠ¡æ—¶çš„å‡ ä¸ªé‡è¦å‚æ•°

.. code:: shell

   executor-cores â€”â€” æ¯ä¸ªexecutorä½¿ç”¨çš„å†…æ ¸æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œå®˜æ–¹å»ºè®®2-5ä¸ªï¼Œæˆ‘ä»¬ä¼ä¸šæ˜¯4ä¸ª
   num-executors â€”â€” å¯åŠ¨executorsçš„æ•°é‡ï¼Œé»˜è®¤ä¸º2
   executor-memory â€”â€” executorå†…å­˜å¤§å°ï¼Œé»˜è®¤1G
   driver-cores â€”â€” driverä½¿ç”¨å†…æ ¸æ•°ï¼Œé»˜è®¤ä¸º1
   driver-memory â€”â€” driverå†…å­˜å¤§å°ï¼Œé»˜è®¤512M

èµ„æºå‚æ•°å‚è€ƒç¤ºä¾‹ä»¥ä¸‹æ˜¯ä¸€ä»½spark-submitå‘½ä»¤çš„ç¤ºä¾‹ï¼Œå¤§å®¶å¯ä»¥å‚è€ƒä¸€ä¸‹ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µè¿›è¡Œè°ƒèŠ‚ï¼š

.. code:: shell

   ./bin/spark-submit \
     --master yarn-cluster \
     --num-executors 100 \
     --executor-memory 6G \
     --executor-cores 4 \
     --driver-memory 1G \
     --conf spark.default.parallelism=1000 \
     --conf spark.storage.memoryFraction=0.5 \
     --conf spark.shuffle.memoryFraction=0.3 \
     --driver-class-path ./conf/postgresql-9.4-1202.jdbc42.jar \
     --jars ./conf/postgresql-9.4-1202.jdbc42.jar bom_variance_inc.py 

.. _5-é¡¹ç›®å¤ç›˜:

5 é¡¹ç›®å¤ç›˜
==========

-  å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ä»£ç ç”¨åŒä¸€å¥—ä»£ç 

   -  é—®é¢˜ï¼šå®¢æˆ·åªæä¾›äº†ä¸€å¥—ç¡¬ä»¶ç¯å¢ƒï¼ŒåŒä¸€å¥—ä»£ç æ— æ³•åŒºåˆ†æµ‹è¯•æ•°æ®åº“å’Œç”Ÿäº§æ•°æ®åº“ï¼Œæœ‰å†²çªï¼›

   -  è§£å†³ï¼šå¢è®¾é…ç½®æ–‡ä»¶ï¼Œä»£ç ä¸­å¯¹æ•°æ®åº“åå¢åŠ å‰ç¼€ï¼›

-  å¤§é‡å¤ç”¨POCé˜¶æ®µæ•°æ®åˆ†æçš„æ•°æ®å¤„ç†ä»£ç å’Œé€»è¾‘

   -  é—®é¢˜ï¼šé€ æˆæ•°æ®å·¥ç¨‹ä¸­æœ‰å¤§é‡æ— æ•ˆè®¡ç®—ï¼Œæµªè´¹è®¡ç®—èµ„æºï¼Œç”Ÿæˆä¸å°‘æ— æ•ˆåº“è¡¨ï¼Œä¸”ä¸ä¾¿äºæ¢³ç†æ•°æ®æµç¨‹ï¼Œè®¡ç®—è¿‡ç¨‹å¤æ‚ï¼›

   -  è§£å†³ï¼šæ¢³ç†æ•°æ®æµç¨‹ï¼Œæ ¹æ®ç®—æ³•å’Œäº§å“éœ€è¦ä¼˜åŒ–è®¡ç®—é€»è¾‘å’Œè¡¨è®¾è®¡ï¼›

-  è¢«åŠ¨æ¥å—äº§å“éœ€æ±‚æ¨åŠ¨

   -  é—®é¢˜ï¼šæ—©æœŸè®¾è®¡ä¸»è¦è€ƒè™‘ç®—æ³•éœ€è¦ï¼Œé¡¹ç›®ä¸­æœŸäº§å“ä¸æ–­æå‡ºæ–°éœ€æ±‚ï¼Œå‡ºç°å¤§é‡ä¸´æ—¶è®¡ç®—é€»è¾‘è°ƒæ•´å’Œå­—æ®µå¢åŠ ï¼›

   -  è§£å†³ï¼šé›†ä¸­æ¢³ç†äº§å“è®¾è®¡æ•°æ®éœ€æ±‚ï¼Œå…¨é¢æ¢³ç†è®¡ç®—é€»è¾‘åç»Ÿä¸€è®¾è®¡è¡¨å’ŒETLé€»è¾‘ï¼›

-  ä½¿ç”¨é—®é¢˜è¿½æº¯çš„æ–¹å¼å¤„ç†æ•°æ®å¼‚å¸¸

   -  é—®é¢˜ï¼šæ—©æœŸéƒ½æ˜¯ä»ARPä¸­çš„KPIã€æ•°æ®å±•ç¤ºå‘ç°é—®é¢˜ï¼Œå†å‘ä¸Šæ¸¸è¿½æº¯æ•°æ®é—®é¢˜ï¼Œåˆ†æéå¸¸è€—æ—¶ï¼›

   -  è§£å†³ï¼šå¼€å‘æ•°æ®ç›‘æ§æœºåˆ¶ï¼Œå¯¹æ•°æ®æºåŒæ­¥ï¼Œæ•°æ®é‡å¤ï¼Œè®¡ç®—ç»“æœçš„æ¡æ•°å’Œé˜ˆå€¼å¼‚å¸¸ç­‰å¢åŠ ç›‘æ§ï¼Œå¹¶å¢åŠ é‚®ä»¶æŠ¥è­¦ï¼›

.. |image1| image:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596455358078-e3770997-3386-4e90-825c-a9d20669fda7.png#align=left&display=inline&height=446&margin=[object Object]&name=image.png&originHeight=1282&originWidth=1104&size=108009&status=done&style=none&width=384
.. |image2| image:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596969572045-d6b5b09d-db6c-4198-a673-ed219ae9aee5.png#align=left&display=inline&height=448&margin=[object Object]&name=image.png&originHeight=896&originWidth=1540&size=541136&status=done&style=none&width=770
.. |image3| image:: https://cdn.nlark.com/yuque/0/2020/png/200056/1596968278717-9e96fa9a-6b35-4d7b-b829-874edbb8d9cb.png#align=left&display=inline&height=348&margin=[object Object]&name=image.png&originHeight=696&originWidth=1334&size=243285&status=done&style=none&width=667
